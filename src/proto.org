* PROTOCAL

** 老协议

|                    | rssi | ber | zone | timestamp | board | lock | states | cmd-type | chargers | locks | pins | temperature | card-no | card-reader | audio | reply-time | ttl | network-reset | network-shutdown | network-heart-rate | network-timeout |
|--------------------+------+-----+------+-----------+-------+------+--------+----------+----------+-------+------+-------------+---------+-------------+-------+------------+-----+---------------+------------------+--------------------+-----------------|
| PING               | ✓    | ✓   |      |           |       |      |        |          | ✓        |       |      | ✓           |         |             |       | ✓          | ✓   | ✓             | ✓                |                    |                 |
| PONG               |      |     | ✓    | ✓         |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| CONFIRM            |      |     |      |           | [✓]   | [✓]  | [✓]    | ✓        |          | [✓]   |      |             | [✓]     | [✓]         |       |            |     |               |                  |                    |                 |
| LOCK_OFF           |      |     |      |           | [✓]   | ✓    |        |          |          |       |      |             | [✓]     | [✓]         |       |            |     |               |                  |                    |                 |
| LOCKS_OFF          |      |     |      |           | ✓     |      |        |          |          | ✓     | ✓    |             |         |             |       |            |     |               |                  |                    |                 |
| LOCK_STATUS        |      |     |      |           | ✓     | [✓]  |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| LOCK_DETECT        |      |     |      |           | ✓     |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| LOCK_STATUS_DETECT |      |     |      |           | ✓     |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| LOCK_DATA          |      |     |      |           | ✓     |      | ✓      |          |          | ✓     |      |             |         |             |       |            |     |               |                  |                    |                 |
| LIGHT_ON           |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| LIGHT_OFF          |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| FAN_ON             |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| FAN_OFF            |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| ULTRAVIOLET_ON     |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| ULTRAVIOLET_OFF    |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| CAMERA_ON          |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| CAMERA_OFF         |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| CHARGER_STATUS     |      |     |      |           |       |      |        |          | ✓        |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| PLAY               |      |     |      |           |       |      |        |          |          |       |      |             |         |             | ✓     |            |     |               |                  |                    |                 |
| VOLUME_UP          |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| VOLUME_DOWN        |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  |                    |                 |
| CONFIG_NETWORK     |      |     |      |           |       |      |        |          |          |       |      |             |         |             |       |            |     |               |                  | ✓                  | ✓               |

#+begin_src scheme :exports code :noweb yes :mkdirp yes :tangle /dev/shm/box-service/src/proto.scm
  (struct parameter
    (int 0 sn) ;; 请求序列号
    (byte 1 version) ;; 版本号
    (short 2 pin) ;; 命令的 PIN 值
    (byte 3 rssi) ;; 信号强度
    (byte 4 ber) ;; 信号强度相关
    (int 5 zone) ;; 时区
    (long 6 timestamp) ;; 服务端时间戳
    (byte 7 board) ;; 锁控板编号
    (byte 8 lock) ;; 锁编号
    (byte* 9 states) ;; 状态(和锁，测物条相关)
    (byte 10 cmd-type) ;; 确认命令类型
    (byte* 11 chargers) ;; 充电状态
    (byte* 12 locks) ;; 锁编号列表
    (short* 13 pins) ;; 开多个锁时的 PIN 列表
    (short 14 temperature) ;; 芯片温度
    (int 15 card-no) ;; 卡编号
    (byte 16 card-reader) ;; 读卡器编号
    (short 17 audio) ;; 音频编号
    (short 18 reply-time) ;; PING 响应时间
    (byte 19 ttl) ;; PING TTL
    (int 20 network-reset) ;; NETWORK RESET 次数
    (int 21 network-shutdown) ;; NETWORK SHUTDOWN 次数
    (int 22 network-heart-rate) ;; NETWORK 心跳频率，必须为 pow(2, n) - 1, 3 < n < 9
    (int 23 network-timeout) ;; NETWORK 超时时间，单位为 100ms
    (byte 24 volume) ;; 音量大小
    )
#+end_src

** 新协议

有效发起者列表

| 命令           | 服务端 | 设备端 |
|----------------+--------+--------|
| PING           | ✓      | ✓      |
| PONG           | ✓      | ✓      |
| ACK            | ✓      | ✓      |
| LOCK-OFF       | ✓      | ✓      |
| LOCKS-OFF      | ✓      |        |
| LOCK-STATUS    | ✓      |        |
| LOCK-DATA      |        | ✓      |
| SET-GPIO       | ✓      |        |
| CLEAR-GPIO     | ✓      |        |
| PLAY           | ✓      |        |
| VOLUME         | ✓      |        |
| CONFIG-NETWORK | ✓      |        |
| CHARGERS       | ✓      |        |
| CHARGERS-DATA  |        | ✓      |

*** PIN 计算规则

**** LOCKS-OFF/LOCK-OFF

countdown + board + lock + timestamp

**** LOCK-STATUS/LOCK-DATA

countdown + board + [status] + timestamp

**** SET-GPIO/CLEAR-GPIO

countdown + gpio + on/off + timestamp

**** PLAY

countdown + speaker + audio + timestamp

**** VOLUME

countdown + speaker + volume + timestamp

**** CONFIG-NETWORK

countdown + heart-rate + timeout + timestamp

**** CHARGERS

countdown + chargers + timestamp

**** CHARGERS-DATA

countdown + chargers + timestamp

*** request

|                | zone | timestamp |  pins | card-no | chargers | battery  |
|----------------+------+-----------+-------+---------+----------+----------|
| PING           | [✓]  | [✓]       |       |         |          |          |
| LOCK-OFF       | [✓]  | [✓]       |       | [✓]     |          |          |
| LOCKS-OFF      | ✓    | ✓         |  ✓    |         |          |          |
| LOCK-STATUS    |      |           |       |         |          |          |
| LOCK-DATA      |      |           |       |         |          |          |
| SET-GPIO       | ✓    | ✓         |       |         |          |          |
| CLEAR-GPIO     | ✓    | ✓         |       |         |          |          |
| PLAY           | ✓    | ✓         |       |         |          |          |
| VOLUME         | ✓    | ✓         |       |         |          |          |
| CONFIG-NETWORK | ✓    | ✓         |       |         |          |          |
| CHARGERS       | ✓    | ✓         |       |         |          |          |
| CHARGERS-DATA  |      |           |       |         | ✓        | ✓        |

#+begin_src scheme :exports code :noweb yes :mkdirp yes :tangle /dev/shm/box-service/src/proto.scm
  (struct request
    (int 0 sn) ;; 请求序列号
    (int 1 pin) ;; 命令的 PIN 值
    (int 2 zone) ;; 时区
    (long 3 timestamp) ;; 服务端时间戳
    (int* 4 pins) ;; 开多个锁时的 PIN 列表
    (int 5 card-no) ;; 卡编号(10位)
    (int 6 chargers) ;; 充电状态
    (byte* 7 battery) ;; 剩余电量
    )
#+end_src

zone 和 timestamp 由发送方来决定是否携带这两个字段。如果发送方是
service，则所有命令都要携带，如果发送方是设备端，则不携带。

*** response

|      | rssi | ber | zone | timestamp |  states | cmd-type | chargers | pins | card-no | reply-time | ttl | network-reset | network-shutdown |
|------+------+-----+------+-----------+---------+----------+----------+------+---------+------------+-----+---------------+------------------|
| PONG | [✓]  | [✓] | ✓    | ✓         |         |          |          |      |         |            |     |               |                  |
| ACK  | [✓]  | [✓] | [✓]  | [✓]       |  [✓]    | ✓        | [✓]      | [✓]  | [✓]     | [✓]        | [✓] | [✓]           | [✓]              |

ACK 命令中，各子命令允许携带的数据列表：

| 命令           | states | chargers | pins | card-no  |
|----------------+--------+----------+------+----------|
| LOCK-OFF       |        |          |      | [✓]      |
| LOCKS-OFF      |        |          | ✓    |          |
| LOCK-STATUS    | ✓      |          |      |          |
| LOCK-DATA      | ✓      |          |      |          |
| SET-GPIO       |        |          |      |          |
| CLEAR-GPIO     |        |          |      |          |
| PLAY           |        |          |      |          |
| VOLUME         |        |          |      |          |
| CONFIG-NETWORK |        |          |      |          |
| CHARGERS       |        | ✓        |      |          |
| CHARGERS-DATA  |        |          |      |          |

#+begin_src scheme :exports code :noweb yes :mkdirp yes :tangle /dev/shm/box-service/src/proto.scm
  (struct response
    (int 0 sn) ;; 请求序列号
    (short 1 pin) ;; 命令的 PIN 值
    (int 2 zone) ;; 时区
    (long 3 timestamp) ;; 服务端时间戳
    (byte 4 rssi) ;; 信号强度
    (byte 5 ber) ;; 信号强度相关
    (byte 6 cmd-type) ;; 确认命令类型
    (short 7 reply-time) ;; PING 响应时间
    (byte 8 ttl) ;; PING TTL
    (int 9 network-reset) ;; NETWORK RESET 次数
    (int 10 network-shutdown) ;; NETWORK SHUTDOWN 次数
    (int 11 chargers) ;; 充电状态
    (byte* 12 battery) ;; 剩余电量
    )
#+end_src

zone 和 timestamp 由发送方来决定是否携带这两个字段。如果发送方是
service，则所有命令都要携带，如果发送方是设备端，则不携带。

rssi 和 ber 只能由设备端来发送。
